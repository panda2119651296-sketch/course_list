import { Assignment } from '../model/Types';

// 1. æ·»åŠ ä½œä¸šå¼¹çª—
@CustomDialog
struct AddAssignmentDialog {
  controller: CustomDialogController;
  confirm: (item: Assignment) => void = () => {};

  @State courseName: string = '';
  @State content: string = '';
  @State deadline: string = '';

  build() {
    Column({ space: 15 }) {
      Text('å¸ƒç½®æ–°ä½œä¸š').fontSize(20).fontWeight(FontWeight.Bold).margin(10)
      TextInput({ placeholder: 'ç§‘ç›® (å¦‚: é©¬åŸ)' }).onChange(v => this.courseName = v)
      TextInput({ placeholder: 'ä½œä¸šå†…å®¹ (å¦‚: 1000å­—è®ºæ–‡)' }).onChange(v => this.content = v)
      TextInput({ placeholder: 'æˆªæ­¢æ—¥æœŸ (YYYY-MM-DD)' }).onChange(v => this.deadline = v) // ä¹Ÿå¯ä»¥ç”¨DatePicker

      Row() {
        Button('å–æ¶ˆ').backgroundColor(Color.Gray).onClick(() => this.controller.close())
        Button('æ·»åŠ ').onClick(() => {
          if (this.content) {
            this.confirm({
              id: Date.now(),
              courseName: this.courseName || 'å…¶ä»–',
              content: this.content,
              deadline: this.deadline || 'å°½å¿«',
              isFinished: false
            });
            this.controller.close();
          }
        })
      }.justifyContent(FlexAlign.SpaceEvenly).width('100%')
    }.padding(20).backgroundColor(Color.White).borderRadius(10)
  }
}

@Component
export struct AssignmentComponent {
  @State assignments: Assignment[] = [];

  dialogController: CustomDialogController = new CustomDialogController({
    builder: AddAssignmentDialog({
      confirm: (item: Assignment) => {
        this.assignments.push(item);
        // ğŸ’¡ è®°å¾—ä¿å­˜æ•°æ®
      }
    }),
    alignment: DialogAlignment.Bottom // å¼¹çª—ä»åº•éƒ¨å¼¹å‡ºï¼Œä½“éªŒæ›´å¥½
  });

  // å®šä¹‰ä¾§æ»‘åˆ é™¤çš„æŒ‰é’®æ ·å¼
  @Builder itemEnd(index: number) {
    Button({ type: ButtonType.Circle }) {
      // âœ… ä¿®å¤ï¼šç›´æ¥ç”¨æ–‡å­— 'åˆ ' ä»£æ›¿å›¾ç‰‡
      Text('åˆ ')
        .fontSize(14)
        .fontColor(Color.White)
    }
    .width(40)
    .height(40)
    .backgroundColor(Color.Red)
    .margin({ left: 10 })
    .onClick(() => {
      this.assignments.splice(index, 1); // ä»æ•°ç»„ä¸­ç§»é™¤
      // ğŸ’¡ è®°å¾—ä¿å­˜æ•°æ®
    })
  }

  // å¦‚æœæ²¡æœ‰iconèµ„æºï¼Œå¯ä»¥ç”¨è¿™ä¸ªçº¯æ–‡å­—ç‰ˆ
  @Builder itemEndText(index: number) {
    Button("åˆ é™¤")
      .backgroundColor(Color.Red)
      .fontColor(Color.White)
      .height('100%')
      .width(80)
      .onClick(() => {
        this.assignments.splice(index, 1);
      })
  }

  build() {
    Column() {
      Row() {
        Text('å¾…åŠæ¸…å•').fontSize(24).fontWeight(FontWeight.Bold)
        Blank()
        // é¡¶éƒ¨æ·»åŠ æŒ‰é’®
        Button('+ æ–°ä½œä¸š').height(30).fontSize(14)
          .onClick(() => this.dialogController.open())
      }.width('95%').margin({ top: 15, bottom: 15 })

      List({ space: 12 }) {
        ForEach(this.assignments, (item: Assignment, index: number) => {
          ListItem() {
            // åŸæœ‰çš„å¡ç‰‡å¸ƒå±€
            Row() {
              Checkbox({ name: 'done' })
                .select(item.isFinished)
                .onChange((val) => item.isFinished = val)

              Column() {
                Text(item.content)
                  .fontSize(16)
                  .decoration({ type: item.isFinished ? TextDecorationType.LineThrough : TextDecorationType.None })
                  .fontColor(item.isFinished ? Color.Gray : Color.Black)

                Row() {
                  Text(item.courseName).fontSize(10).backgroundColor('#F0F0F0').padding(4).borderRadius(4)
                  Blank().width(10)
                  Text(item.deadline).fontSize(10).fontColor(Color.Red)
                }.margin({ top: 5 })
              }.alignItems(HorizontalAlign.Start).margin({ left: 10 })
            }
            .width('100%')
            .padding(15)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .shadow({ radius: 4, color: '#10000000' })
          }
          // ğŸ”¥ æ ¸å¿ƒï¼šæ·»åŠ ä¾§æ»‘åˆ é™¤åŠŸèƒ½
          .swipeAction({ end: this.itemEndText(index) })
        })
      }
      .width('95%')
      .layoutWeight(1)

      if (this.assignments.length === 0) {
        Text('æš‚æ— ä½œä¸šï¼Œå»ä¼‘æ¯å§~').fontColor(Color.Gray).margin({top: 50})
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}